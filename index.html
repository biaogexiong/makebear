<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>錶哥網-客製化小熊</title>
  <style>
    :root{
      --green-50:#ecfdf5; --green-100:#d1fae5; --green-200:#a7f3d0; --green-300:#6ee7b7; --green-400:#34d399; --green-500:#10b981; --green-600:#059669; --green-700:#047857; --green-800:#065f46; --green-900:#064e3b;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,"Helvetica Neue",Arial; background:var(--green-50); color:#0a0a0a}

    .app{max-width:min(1100px, 95vw); margin:24px auto; padding:16px; background:white; border:1px solid var(--green-200); border-radius:16px; box-shadow:0 8px 24px rgba(16,185,129,.15)}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 12px; border-radius:12px; background:linear-gradient(180deg, var(--green-100), #fff)}
    header .title{display:flex; align-items:center; gap:10px; font-weight:800; color:var(--green-800)}
    header .title .dot{width:12px; height:12px; border-radius:50%; background:var(--green-500); box-shadow:0 0 0 4px var(--green-200)}
    header .actions{display:flex; gap:8px; flex-wrap:wrap}
    button, .btn{appearance:none; border:none; cursor:pointer; padding:10px 14px; border-radius:12px; background:var(--green-600); color:white; font-weight:700; box-shadow:0 6px 16px rgba(5,150,105,.25); transition:.2s transform,.2s box-shadow,.2s background}
    button:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(5,150,105,.28)}
    button.secondary{background:var(--green-200); color:var(--green-900)}
    button.ghost{background:transparent; color:var(--green-800); border:1px solid var(--green-300)}

    .stage{display:grid; grid-template-columns:1fr; gap:12px; padding:16px}
    .canvas-wrap{position:relative; width:100%; background: conic-gradient(from 180deg at 50% 50%, var(--green-50), white); border:1px solid var(--green-200); border-radius:16px; overflow:hidden}
    canvas{display:block; width:100%; height:auto; image-rendering:crisp-edges; image-rendering:pixelated; touch-action:none}

    .palette{display:flex; align-items:center; gap:10px; flex-wrap:wrap; padding:12px 14px; background:var(--green-100); border:1px solid var(--green-200); border-radius:14px}
    .palette .label{font-weight:800; color:var(--green-800)}
    .swatchbar{display:flex; gap:8px; flex-wrap:wrap}
    .swatch{width:36px; height:36px; border-radius:10px; border:2px solid rgba(0,0,0,.08); box-shadow:inset 0 0 0 2px rgba(255,255,255,.4); cursor:pointer; position:relative}
    .swatch[data-active="true"]{outline:3px solid var(--green-500)}

    .toolbar{display:flex; justify-content:space-between; align-items:center; gap:12px; padding:8px 12px}
    .slider{display:flex; align-items:center; gap:8px}
    .slider input[type="range"]{accent-color:var(--green-600)}

    .hint{padding:8px 12px; background:var(--green-50); border:1px dashed var(--green-300); color:var(--green-800); border-radius:12px; font-size:14px}
    .hint code{background:#f3f4f6; padding:2px 6px; border-radius:6px}

    footer{margin-top:8px; padding:6px 2px; text-align:center; color:var(--green-700); font-size:12px}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="客製化小熊">
    <header>
      <div class="title"><span class="dot" aria-hidden="true"></span>客製化小熊</div>
      <div class="actions">
        <button id="downloadBtn" title="下載">下載</button>
        <button id="clearBtn" class="secondary" title="清除你的塗鴉，保留小熊模板">清除塗鴉</button>
      </div>
    </header>

    <div class="stage">
      <div class="toolbar">
        <div class="palette" aria-label="顏色">
          <span class="label">顏色：</span>
          <div id="swatches" class="swatchbar" role="listbox" aria-label="顏色清單"></div>
        </div>
        <div class="slider">
          <label for="brush" style="font-weight:700; color:var(--green-800)">筆刷：</label>
          <input id="brush" type="range" min="2" max="40" value="10" />
        </div>
      </div>

      <div class="canvas-wrap">
        <canvas id="canvas" aria-label="可在白色區域作畫的畫布"></canvas>
      </div>

      <div class="hint">提示：只能在 <strong>白色區域</strong>塗鴉（邊框與去背區不可畫）。按住滑鼠或手指即可連續繪畫。預設顏色為綠色。</div>
    </div>

    <footer>© 2025 錶哥熊</footer>
  </div>

  <script>
    // === 設定 ===
    const IMAGE_URL = "https://biaogexiong.github.io/makebear/makebear_canva.png"; // 小熊模板
    const DEFAULT_COLOR = "#10b981"; // 預設綠色
    const COLOR_SET = [
      "#10b981", // 綠 (預設)
      "#16a34a", // 深綠
      "#22c55e", // 草綠
      "#3b82f6", // 藍
      "#eab308", // 黃
      "#ef4444", // 紅
      "#a855f7", // 紫
      "#0f172a", // 墨黑
      "#ffffff"  // 白
    ];

    // === DOM ===
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // 用於做「可畫區域」檢測的遮罩畫布（不顯示）
    const maskCanvas = document.createElement('canvas');
    const maskCtx = maskCanvas.getContext('2d');

    const brush = document.getElementById('brush');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const swatchesWrap = document.getElementById('swatches');

    // 狀態
    let drawing = false;
    let currentColor = DEFAULT_COLOR;
    let lastAllowed = null; // 上一個允許繪製的點
    let imgLoaded = false;

    // 建立顏色物品欄
    function buildSwatches(){
      swatchesWrap.innerHTML = '';
      COLOR_SET.forEach((c,i)=>{
        const b = document.createElement('button');
        b.className = 'swatch';
        b.style.background = c;
        b.setAttribute('role','option');
        b.setAttribute('aria-label', `顏色 ${c}`);
        b.dataset.color = c;
        if(c.toLowerCase() === DEFAULT_COLOR.toLowerCase()) b.dataset.active = 'true';
        b.addEventListener('click', () => {
          currentColor = c;
          document.querySelectorAll('.swatch').forEach(s=>delete s.dataset.active);
          b.dataset.active = 'true';
        });
        swatchesWrap.appendChild(b);
      });
    }

    buildSwatches();

    // 載入圖片並初始化畫布
    const baseImg = new Image();
    baseImg.crossOrigin = 'anonymous';
    baseImg.onload = () => {
      const w = baseImg.naturalWidth;
      const h = baseImg.naturalHeight;
      canvas.width = maskCanvas.width = w;
      canvas.height = maskCanvas.height = h;

      // 將模板畫上主畫布與遮罩畫布
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(baseImg,0,0,w,h);

      maskCtx.clearRect(0,0,w,h);
      maskCtx.drawImage(baseImg,0,0,w,h);

      // 為了讓使用者畫在模板之上，我們將模板像底圖：
      // 先把模板像素保存，接下來的繪圖在同一畫布上進行即可
      imgLoaded = true;
    };
    baseImg.onerror = () => {
      alert('無法載入小熊模板');
    };
    baseImg.src = IMAGE_URL;

    // 計算座標（考慮 CSS 縮放）
    function getPos(e){
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const clientX = e.clientX !== undefined ? e.clientX : (e.touches && e.touches[0].clientX);
      const clientY = e.clientY !== undefined ? e.clientY : (e.touches && e.touches[0].clientY);
      return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
      };
    }

    // 僅允許在「白色」區域繪製（排除邊框、去背區）
    function isWhitePixel(x, y){
      // clamp 範圍
      x = Math.max(0, Math.min(canvas.width-1, Math.round(x)));
      y = Math.max(0, Math.min(canvas.height-1, Math.round(y)));
      const pix = maskCtx.getImageData(x, y, 1, 1).data; // [r,g,b,a]
      const r = pix[0], g = pix[1], b = pix[2], a = pix[3];
      const nearWhite = (r>250 && g>250 && b>250 && a>250); // 閥值可微調
      return nearWhite;
    }

    function pointerDown(e){
      if(!imgLoaded) return;
      e.preventDefault();
      drawing = true;
      const {x,y} = getPos(e);
      lastAllowed = isWhitePixel(x,y) ? {x,y} : null;
    }

    function pointerMove(e){
      if(!drawing || !imgLoaded) return;
      e.preventDefault();
      const {x,y} = getPos(e);
      const allowed = isWhitePixel(x,y);
      const size = parseInt(brush.value,10) || 10;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = size;

      if(allowed && lastAllowed){
        ctx.beginPath();
        ctx.moveTo(lastAllowed.x, lastAllowed.y);
        ctx.lineTo(x, y);
        ctx.stroke();
        lastAllowed = {x,y};
      } else if(allowed && !lastAllowed){
        // 之前不允許，現在允許 -> 從此點重新開始
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x+0.01, y+0.01); // 觸發一個極短線，等同點繪
        ctx.stroke();
        lastAllowed = {x,y};
      } else {
        // 不允許畫 -> 中斷
        lastAllowed = null;
      }
    }

    function pointerUp(e){
      drawing = false;
      lastAllowed = null;
    }

    // 事件（滑鼠 + 觸控 + 指標）
    canvas.addEventListener('pointerdown', pointerDown);
    canvas.addEventListener('pointermove', pointerMove);
    window.addEventListener('pointerup', pointerUp);

    // 下載圖檔
    downloadBtn.addEventListener('click', () => {
      if(!imgLoaded){ alert('圖片尚未載入完成'); return; }
      // 直接下載目前畫布內容（含模板 + 繪製）
      const link = document.createElement('a');
      link.download = 'bear-canvas.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // 清除塗鴉（保留模板）
    clearBtn.addEventListener('click', () => {
      if(!imgLoaded) return;
      ctx.clearRect(0,0,canvas.width, canvas.height);
      ctx.drawImage(baseImg,0,0,canvas.width, canvas.height);
    });

    // 防止雙指縮放 & 長按彈出選單
    document.addEventListener('gesturestart', e=>e.preventDefault());
    document.addEventListener('contextmenu', e=>e.preventDefault());
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>錶哥網-客製化小熊</title>
  <style>
    :root{
      --green-50:#ecfdf5; --green-100:#d1fae5; --green-200:#a7f3d0; --green-300:#6ee7b7; --green-400:#34d399; --green-500:#10b981; --green-600:#059669; --green-700:#047857; --green-800:#065f46; --green-900:#064e3b;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,"Helvetica Neue",Arial; background:var(--green-50); color:#0a0a0a}

    .app{max-width:min(1100px, 95vw); margin:24px auto; padding:16px; background:white; border:1px solid var(--green-200); border-radius:16px; box-shadow:0 8px 24px rgba(16,185,129,.15)}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 12px; border-radius:12px; background:linear-gradient(180deg, var(--green-100), #fff)}
    header .title{display:flex; align-items:center; gap:10px; font-weight:800; color:var(--green-800)}
    header .title .dot{width:12px; height:12px; border-radius:50%; background:var(--green-500); box-shadow:0 0 0 4px var(--green-200)}
    header .actions{display:flex; gap:8px; flex-wrap:wrap}
    button, .btn{appearance:none; border:none; cursor:pointer; padding:10px 14px; border-radius:12px; background:var(--green-600); color:white; font-weight:700; box-shadow:0 6px 16px rgba(5,150,105,.25); transition:.2s transform,.2s box-shadow,.2s background}
    button:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(5,150,105,.28)}
    button.secondary{background:var(--green-200); color:var(--green-900)}
    button.ghost{background:transparent; color:var(--green-800); border:1px solid var(--green-300)}

    .stage{display:grid; grid-template-columns:1fr; gap:12px; padding:16px}
    .canvas-wrap{position:relative; width:100%; background: conic-gradient(from 180deg at 50% 50%, var(--green-50), white); border:1px solid var(--green-200); border-radius:16px; overflow:hidden}
    canvas{display:block; width:100%; height:auto; image-rendering:crisp-edges; image-rendering:pixelated; touch-action:none}

    .palette{display:flex; align-items:center; gap:10px; flex-wrap:wrap; padding:12px 14px; background:var(--green-100); border:1px solid var(--green-200); border-radius:14px}
    .palette .label{font-weight:800; color:var(--green-800)}
    .swatchbar{display:flex; gap:8px; flex-wrap:wrap}
    .swatch{width:36px; height:36px; border-radius:10px; border:2px solid rgba(0,0,0,.08); box-shadow:inset 0 0 0 2px rgba(255,255,255,.4); cursor:pointer; position:relative}
    .swatch[data-active="true"]{outline:3px solid var(--green-500)}

    .toolbar{display:flex; justify-content:space-between; align-items:center; gap:12px; padding:8px 12px}
    .slider{display:flex; align-items:center; gap:8px}
    .slider input[type="range"]{accent-color:var(--green-600)}

    .hint{padding:8px 12px; background:var(--green-50); border:1px dashed var(--green-300); color:var(--green-800); border-radius:12px; font-size:14px}
    .hint code{background:#f3f4f6; padding:2px 6px; border-radius:6px}

    footer{margin-top:8px; padding:6px 2px; text-align:center; color:var(--green-700); font-size:12px}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="客製化小熊">
    <header>
      <div class="title"><span class="dot" aria-hidden="true"></span>客製化小熊</div>
      <div class="actions">
        <button id="downloadBtn" title="下載">下載</button>
        <button id="clearBtn" class="secondary" title="清除你的塗鴉，保留小熊模板">清除塗鴉</button>
      </div>
    </header>

    <div class="stage">
      <div class="toolbar">
        <div class="palette" aria-label="顏色">
          <span class="label">顏色：</span>
          <div id="swatches" class="swatchbar" role="listbox" aria-label="顏色清單"></div>
        </div>
        <div class="slider">
          <label for="brush" style="font-weight:700; color:var(--green-800)">筆刷：</label>
          <input id="brush" type="range" min="2" max="40" value="10" />
        </div>
      </div>

      <div class="canvas-wrap">
        <canvas id="canvas" aria-label="可在白色區域作畫的畫布"></canvas>
      </div>

      <div class="hint">提示：只能在 <strong>白色區域</strong>塗鴉（邊框與去背區不可畫）。按住滑鼠或手指即可連續繪畫。預設顏色為綠色。</div>
    </div>

    <footer>© 2025 錶哥熊</footer>
  </div>

  <script>
    // === 設定 ===
    const IMAGE_URL = "https://biaogexiong.github.io/makebear/makebear_canva.png"; // 小熊模板
    const DEFAULT_COLOR = "#10b981"; // 預設綠色
    const COLOR_SET = [
      "#10b981", // 綠 (預設)
      "#16a34a", // 深綠
      "#22c55e", // 草綠
      "#3b82f6", // 藍
      "#eab308", // 黃
      "#ef4444", // 紅
      "#a855f7", // 紫
      "#0f172a", // 墨黑
      "#ffffff"  // 白
    ];

    // === DOM ===
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // 用於做「可畫區域」檢測的遮罩畫布（不顯示）
    const maskCanvas = document.createElement('canvas');
    const maskCtx = maskCanvas.getContext('2d');

    const brush = document.getElementById('brush');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const swatchesWrap = document.getElementById('swatches');

    // 狀態
    let drawing = false;
    let currentColor = DEFAULT_COLOR;
    let lastAllowed = null; // 上一個允許繪製的點
    let imgLoaded = false;

    // 建立顏色物品欄
    function buildSwatches(){
      swatchesWrap.innerHTML = '';
      COLOR_SET.forEach((c,i)=>{
        const b = document.createElement('button');
        b.className = 'swatch';
        b.style.background = c;
        b.setAttribute('role','option');
        b.setAttribute('aria-label', `顏色 ${c}`);
        b.dataset.color = c;
        if(c.toLowerCase() === DEFAULT_COLOR.toLowerCase()) b.dataset.active = 'true';
        b.addEventListener('click', () => {
          currentColor = c;
          document.querySelectorAll('.swatch').forEach(s=>delete s.dataset.active);
          b.dataset.active = 'true';
        });
        swatchesWrap.appendChild(b);
      });
    }

    buildSwatches();

    // 載入圖片並初始化畫布
    const baseImg = new Image();
    baseImg.crossOrigin = 'anonymous';
    baseImg.onload = () => {
      const w = baseImg.naturalWidth;
      const h = baseImg.naturalHeight;
      canvas.width = maskCanvas.width = w;
      canvas.height = maskCanvas.height = h;

      // 將模板畫上主畫布與遮罩畫布
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(baseImg,0,0,w,h);

      maskCtx.clearRect(0,0,w,h);
      maskCtx.drawImage(baseImg,0,0,w,h);

      // 為了讓使用者畫在模板之上，我們將模板像底圖：
      // 先把模板像素保存，接下來的繪圖在同一畫布上進行即可
      imgLoaded = true;
    };
    baseImg.onerror = () => {
      alert('無法載入小熊模板');
    };
    baseImg.src = IMAGE_URL;

    // 計算座標（考慮 CSS 縮放）
    function getPos(e){
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const clientX = e.clientX !== undefined ? e.clientX : (e.touches && e.touches[0].clientX);
      const clientY = e.clientY !== undefined ? e.clientY : (e.touches && e.touches[0].clientY);
      return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
      };
    }

    // 僅允許在「白色」區域繪製（排除邊框、去背區）
    function isWhitePixel(x, y){
      // clamp 範圍
      x = Math.max(0, Math.min(canvas.width-1, Math.round(x)));
      y = Math.max(0, Math.min(canvas.height-1, Math.round(y)));
      const pix = maskCtx.getImageData(x, y, 1, 1).data; // [r,g,b,a]
      const r = pix[0], g = pix[1], b = pix[2], a = pix[3];
      const nearWhite = (r>250 && g>250 && b>250 && a>250); // 閥值可微調
      return nearWhite;
    }

    function pointerDown(e){
      if(!imgLoaded) return;
      e.preventDefault();
      drawing = true;
      const {x,y} = getPos(e);
      lastAllowed = isWhitePixel(x,y) ? {x,y} : null;
    }

    function pointerMove(e){
      if(!drawing || !imgLoaded) return;
      e.preventDefault();
      const {x,y} = getPos(e);
      const allowed = isWhitePixel(x,y);
      const size = parseInt(brush.value,10) || 10;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = size;

      if(allowed && lastAllowed){
        ctx.beginPath();
        ctx.moveTo(lastAllowed.x, lastAllowed.y);
        ctx.lineTo(x, y);
        ctx.stroke();
        lastAllowed = {x,y};
      } else if(allowed && !lastAllowed){
        // 之前不允許，現在允許 -> 從此點重新開始
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x+0.01, y+0.01); // 觸發一個極短線，等同點繪
        ctx.stroke();
        lastAllowed = {x,y};
      } else {
        // 不允許畫 -> 中斷
        lastAllowed = null;
      }
    }

    function pointerUp(e){
      drawing = false;
      lastAllowed = null;
    }

    // 事件（滑鼠 + 觸控 + 指標）
    canvas.addEventListener('pointerdown', pointerDown);
    canvas.addEventListener('pointermove', pointerMove);
    window.addEventListener('pointerup', pointerUp);

    // 下載圖檔
    downloadBtn.addEventListener('click', () => {
      if(!imgLoaded){ alert('圖片尚未載入完成'); return; }
      // 直接下載目前畫布內容（含模板 + 繪製）
      const link = document.createElement('a');
      link.download = 'bear-canvas.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // 清除塗鴉（保留模板）
    clearBtn.addEventListener('click', () => {
      if(!imgLoaded) return;
      ctx.clearRect(0,0,canvas.width, canvas.height);
      ctx.drawImage(baseImg,0,0,canvas.width, canvas.height);
    });

    // 防止雙指縮放 & 長按彈出選單
    document.addEventListener('gesturestart', e=>e.preventDefault());
    document.addEventListener('contextmenu', e=>e.preventDefault());
  </script>
</body>
</html>
